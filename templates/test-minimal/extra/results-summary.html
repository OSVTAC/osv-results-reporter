{% extends "base.html" %}

{% block title %}Summary Results{% endblock %}

{% block styles %}
{# TODO move to static/tables.css once render_template_dir() supports that #}
<link rel="stylesheet" href="tables.css">
{% endblock %}

{% macro anchored_header(text, element_id) -%}
{{ text|translate }}
  <a class="headerlink" href="{{ element_id|to_fragment }}" title="Permalink to this header">¶</a>
{%- endmacro %}

{% block content %}
  <h3>Contents</h3>

  <ul>
  {% for headers, contests in election.contests_with_headers() %}
    {% for level, header in headers %}
      {% set header_id = header.ballot_title|to_element_id %}
      <li>
        <a href="{{ header_id|to_fragment }}">{{ header.ballot_title|translate }}</a>
      {%- if not loop.last %}
      </li>
      {% endif -%}
    {% endfor %}
      <ul>
        <li>
          {% for contest in contests %}
            {% set contest_id = contest.contest_name|to_element_id %}
            <a href="{{ contest_id|to_fragment }}">
            {# Prevent contest names from breaking across lines in the table of contents. #}
            {{ contest.contest_name|translate|escape|nobreak|safe }}</a>{%- if not loop.last %}&nbsp;●{% endif -%}
          {% endfor %}
        </li>
      </ul>
    </li>
  {% endfor %}
  </ul>

  <p>
  {% with %}
    {% for headers, contests in election.contests_with_headers() %}
      {% for level, header in headers %}
        {% set header_id = header.ballot_title|to_element_id %}
        {% if level == 1 %}
          <h3 id="{{ header_id }}">{{ anchored_header(header.ballot_title, header_id) }}</h3>
        {% else %}
          <h4 id="{{ header_id }}">{{ anchored_header(header.ballot_title, header_id) }}</h4>
        {% endif %}
      {% endfor %}

    {% for contest in contests %}
      {# Compute detailed results now so we can link to the results file below. #}
      {% set rel_path_template = contest|contest_path_template("results-detail") %}
      {% set rel_output_path = rel_path_template|format_path %}

      {# Set options so the objects are available within the subtemplate. #}
      {% set options.contest = contest %}
      {% set options.headers = headers %}
      {% do subtemplate('results-detail.html', rel_path_template) %}

    {% set contest_id = contest.contest_name|to_element_id %}
    <p id="{{ contest_id }}">{{ anchored_header(contest.contest_name, contest_id) }}
    </p>
    {% if contest.vote_for_msg %}
      <p>
        {{ contest.vote_for_msg|translate }}
      </p>
    {% endif %}
    <p>{{ contest.precincts_reporting }} of {{ contest.total_precincts}} Precincts Reporting ({{ contest.precincts_reporting|format_percent2(contest.total_precincts) }})
    {% if contest.is_rcv %}
      {% set rcv_path_template = contest|contest_path_template("results-rcv") %}
      {% set rcv_path = rcv_path_template|format_path %}
      {% do subtemplate('results-rcv.html', rcv_path_template) %}
      <a href="{{ rcv_path }}">[RCV rounds]</a>
    {% endif %}
    <a href="{{ rel_output_path }}">[Detailed results]</a>
    </p>
    {% if contest.is_rcv %}
      {# Pass the id of the ResultStatType object corresponding to continuing ballots. #}
      {% set rcv_results = contest.make_rcv_results("RSTot") %}
      <table class="table summary-table">
        <thead>
          <tr>
            <th></th>
            <th>Votes</th>
            <th>Round</th>
            <th>Percent</th>
            <th class="bars-header"></th>
          </tr>
        </thead>
        <tbody class="choices">
          {# HACK: overwriting variables within loops doesn't work in Jinja, but updating dicts does #}
          {% set winnerPercent = {'percent': 100} %}
          {% for choice, round in rcv_results.rcv_summary() %}
            <tr {%- if choice.is_successful %} class="successful"{% endif -%}>
              <td class="text-cell title">{{ choice.ballot_title|translate }}</td>
              <td>{{ round.votes }}</td>
              <td>{{ round.round_num }}</td>
              <td>{{ round.percent|format_percent }}</td>
              {# HACK: this assumes the winner is the first candidate, and that there is only one winner #}
              {%- if choice.is_successful -%}
                {%- if winnerPercent.update({'percent': round.percent}) -%}{%- endif -%}
              {%- endif -%}
              <td class="bars-row">
                  <div class="percentage-bar" style="width: {{ round.percent|compute_percent(winnerPercent.percent) }}%"></div>
                  <div class="cutoff-line" style="left: calc({{ 50|compute_percent(winnerPercent.percent) }}% - 0.25em)"></div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
    <table class="table summary-table">
      <thead>
        <tr>
          <th>&nbsp;</th>
          {% for vg in contest.voting_groups_from_idlist() %}
            <th>{{ vg.heading }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody class="choices">
        {% for choice in contest.choices %}
          <tr {%- if choice.is_successful %} class="successful"{% endif -%}>
            <td class="text-cell title">{{ choice.ballot_title|translate }}</td>
            {% for v in contest.summary_results(choice) %}
              <td>{{ v }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
      <tbody class="result-stats">
        {% for result_stat in contest.result_stats %}
          <tr>
            <td class="text-cell">{{ result_stat.heading }}</td>
            {% for v in contest.summary_results(result_stat) %}
              <td>{{ v|format_number}}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    {% endfor %} {# End iterating over the contests. #}
    {% endfor %} {# End iterating over (headers, contests) pairs. #}
  {% endwith %}
{% endblock %}
